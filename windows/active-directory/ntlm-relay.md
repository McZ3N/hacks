---
description: Authentication | Protocol | LM | NTLMv1 | NTLMv2
---

# NTLM Relay

Beside Kerberos there is another difference authentication protocol used in AD networks. [NT Lan Manager](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-nlmp/c50a85f0-5940-42d8-9e82-ed206902e919) (`NTLM`/[MS-NLMP](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-nlmp/b38c36ed-2804-4868-a9ff-8dd3182128e4)) is the name of a family of security protocols.&#x20;

* LM
* NTLMv1
* NTLMv2

NTLM security protocols are embedded meaning it doesn't have its own way of sending and receiving messages across a network. therefore NTLM allows or uses any protocol with a defined layer in the network stack like SMB or HTTS.

> NTLM provides three operations:
>
> 1. Authentication
> 2. Message integrity, or message signing
> 3. Message confidentiality, or message sealing.

NTLM is a challenge-response protocl meaning it back-and-forth steps between user and server to confirm a user's identity. It generates unique, one-time numbers called nonces to prevent attackers from reusing old messages.

### <mark style="color:yellow;">Authentication Workflow</mark>

NTLM authentication workflow for domain joined computers begins with the client and server exchanging application protocol messages, where the client signals to wanting to authenticate. The client and server exchange 3 NLTM messages:

1. NEGOTIATE\_MESSAGE (Type 1 message)
2. CHALLENGE\_MESSAGE (Type 2 message)
3. AUTHENTICATE\_MESSAGE (Type 3 message)

### <mark style="color:yellow;">NTLM Message</mark>

An NTLM message has variable length with a fixed-length header and variable-size message payload. Header begins with signature and messagetype fields.&#x20;

<figure><img src="../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

#### NEGOTIATE\_MESSAGE

This message indicates the client wants to authenticate and specifies the NTLM options it supports/requests. In the NEGOTIATIE\_MESSAGE there is the NegotiateFlags field which 4 bytes long present in all messages. Those flags indicate which NLTM capabilities are supported or request by sender.

#### CHALLENGE\_MESSAGE

This message can support and challenge a client to prove its identity. It has 6 fixed length fields, with NegotiateFlags and ServerChallenge. ServerChallenge is a 64-bit nonce which holds the NTLM challenge generated by the server.&#x20;

{% hint style="info" %}
Get info within CHALLENGE\_MESSAGE

```
python3 examples/DumpNTLMInfo.py 172.16.117.3
```
{% endhint %}

#### AUTHENTICATE\_MESSAGE

Sent by the client to the server to prove its possession of the shared secret key. It contains `LmChallengeResponseFields` and `NtChallengeResponseFields.`&#x20;

### <mark style="color:yellow;">Message Signing and Sealing</mark>

Message signing helps against relay attacks by negotiating a session key to sign all messages exchanged. The session key is generated based on client/server challenge messages and users's password hash. Once session key is established all messages are signed using a MAC.&#x20;

Message sealing provided message confidentiality by using a symmetric-key encrption mechanism. This way attackers cannot read or tamper with it. Every sealed message is also signed.

## NTLM Relay Attack

The NTLM Relay attack is an Man-in-the-Middle attack. Microsoft chooses in many cases for Kerberos authentication as its better and more secure.&#x20;

#### Situation in which Kerberos cannot be used:

* Compatibility with older systems
* Kerberos configuration not setup correctly
* Non-domain joined server
* Protoco that chooses not to support Kerberos but NLMP only.

{% hint style="info" %}
#### NLTM is vulnerable to Relay Attacks because of lack of mutual authentication.&#x20;

1. The client authenticates to the server, but the server does not authenticate itself to the client.
2. The client does not verify whether it is communicating with the legitimate server or a malicious one.
{% endhint %}

### <mark style="color:yellow;">How does it work</mark>

{% stepper %}
{% step %}
#### Pretending to be a legitimate server

The attacker acts like a legitimate server that the client wants to authenticate with.
{% endstep %}

{% step %}
#### Pretending to be a legitimate client

At the same time, the attacker also impersonates the legitimate client to the actual server that offers the service.
{% endstep %}

{% step %}
**Relaying messages**

The attacker intercepts and forwards messages between the client and the server. They pass authentication messages back and forth until the server thinks the client is authenticated.
{% endstep %}

{% step %}
**Establishing an authenticated session**

Once the attacker has relayed the authentication messages and established a session with the server, the attacker now has access to the server as if they were the legitimate client
{% endstep %}

{% step %}
#### Abusing the session

With the authenticated session in place, the attacker can perform actions on the server that the legitimate client is authorized to do. These actions could include accessing sensitive data or carrying out other privileged tasks.
{% endstep %}

{% step %}
#### Disrupting the client

After the attacker has used the session, they may send an application message to the client saying that authentication failed or simply disconnect the client, making it unaware of the attack.
{% endstep %}
{% endstepper %}

### <mark style="color:yellow;">Pre-relay</mark>

Pre-relay is a technique where a client is coerced into NTLM authentication for a service on a server. Techniques like poisoning and spoofing are used for this.&#x20;

**LLMNR, NBT-NS, and mDNS Poisoning**

In enterprise networks DNS is used a lot however when DNS is not properfly configured it happens clients using name resolution that standard DNS servers do not resolve, caused by incomplete DNS records or unavailable servers. To solve this alternative name resolution protocols are used.

* **LLMNR (Link-Local Multicast Name Resolution)**: A protocol for resolving names in local networks when DNS isn't available.
* **NBT-NS (NetBIOS Name Service)**: An older protocol used for resolving NetBIOS names in a local network.

{% hint style="info" %}
DNS is **unicast** meaning a client asks directly for a name resolution while **multicast** means it will broadcast the network if anyone knows the name.&#x20;
{% endhint %}

### <mark style="color:yellow;">Relay</mark>

Relaying the NTLM authentication of the client to a relay target. Therefore find machines with SMB have SMB signing disabled.&#x20;

```bash
# Check if SMB signing is disabled
python3 RunFinger.py -i 172.16.117.0/

# With nxc
smb 172.16.117.0/24 --gen-relay-list relayTargets.txt
```

### <mark style="color:yellow;">Post Relay</mark>

Having a authenticated session by relaying the victims NTLM authentication there are many post-relay attacks that can be done.&#x20;

<table><thead><tr><th>Component</th><th width="572">Explanation</th></tr></thead><tbody><tr><td>Coercion method</td><td>Coerce client into performing authentication like MiTM.</td></tr><tr><td>Incoming NTLM auth over</td><td>Protocols client uses to perform NTLM authentication with HTTP(1), SMB(2).</td></tr><tr><td>Client-Side mitigation</td><td>Client-Side mitigations clients have to protect against NTLM relay attacks.</td></tr><tr><td>Server-Side mitigation</td><td>Server-Side mitigations servers have to protect against NLTM relay attacks.</td></tr><tr><td>Relayed NTLM auth over</td><td>Protocols that we can relay NLTM authentication received from client, like HTTP, HTTS, SMB, LDAP and LDAPS</td></tr><tr><td>Post-relay attack</td><td>These are the post-relay attacks that we can carry out depending on the protocol of the <code>Relayed NTLM auth over</code> component.</td></tr></tbody></table>





